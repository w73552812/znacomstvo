<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Dating Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #fe3c72; /* –¶–≤–µ—Ç –¢–∏–Ω–¥–µ—Ä–∞ */
            --bg: var(--tg-theme-bg-color, #f5f5f5);
            --text: var(--tg-theme-text-color, #222);
            --hint: var(--tg-theme-hint-color, #999);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –®–∞–ø–∫–∞ */
        header { height: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.1); }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .page { display: none; flex: 1; position: relative; overflow-y: auto; padding: 20px; }
        .page.active { display: flex; flex-direction: column; }

        /* –õ–ï–ù–¢–ê –ò –°–í–ê–ô–ü–´ */
        #feed { overflow: hidden; justify-content: center; align-items: center; }
        .card-container { width: 100%; height: 80vh; position: relative; perspective: 1000px; }
        .card { 
            position: absolute; width: 100%; height: 100%; border-radius: 20px; 
            background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden; touch-action: none; transform-origin: 50% 100%;
        }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-info { 
            position: absolute; bottom: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white;
        }

        /* –ü–†–û–§–ò–õ–¨ */
        .profile-form { display: flex; flex-direction: column; gap: 15px; }
        .profile-form input, .profile-form textarea, .profile-form select {
            padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px;
        }
        .btn-save { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; }

        /* –ú–≠–¢–ß–ò */
        .match-item { display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .match-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        nav { 
            height: 70px; background: var(--tg-theme-secondary-bg-color, #fff); 
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--hint); cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span { font-size: 24px; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ª–∞–π–∫–∞ */
        .stamp { 
            position: absolute; top: 40px; padding: 5px 10px; border: 4px solid; border-radius: 10px; 
            text-transform: uppercase; font-size: 30px; font-weight: bold; opacity: 0; transform: rotate(-20deg);
        }
        .stamp.like { border-color: #4bdf80; color: #4bdf80; right: 40px; }
        .stamp.nope { border-color: #ff4b4b; color: #ff4b4b; left: 40px; transform: rotate(20deg); }
    </style>
</head>
<body>

    <header id="header-title">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</header>

    <div id="feed" class="page active">
        <div class="card-container" id="card-stack">
            <div class="card" id="main-card">
                <div class="stamp like">LIKE</div>
                <div class="stamp nope">NOPE</div>
                <img src="https://images.unsplash.com/photo-1517841905240-472988babdf9?w=500" id="user-photo">
                <div class="card-info">
                    <h2 id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <p id="user-bio">–ò—â–µ–º –ª—é–¥–µ–π –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</p>
                </div>
            </div>
        </div>
    </div>

    <div id="matches" class="page">
        <h3>–í–∞—à–∏ —Å–∏–º–ø–∞—Ç–∏–∏</h3>
        <div id="matches-list" style="margin-top: 20px;">
            <p style="color: gray;">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –°–≤–∞–π–ø–∞–π—Ç–µ —á–∞—â–µ!</p>
        </div>
    </div>

    <div id="profile" class="page">
        <div class="profile-form">
            <label>–í–∞—à–µ –∏–º—è</label>
            <input type="text" id="form-name" placeholder="–ò–º—è">
            <label>–û —Å–µ–±–µ</label>
            <textarea id="form-bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ"></textarea>
            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)</label>
            <input type="text" id="form-photo" placeholder="https://...">
            <button class="btn-save" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <nav>
        <div class="nav-btn active" onclick="showPage('feed')"><span>üî•</span>–õ–µ–Ω—Ç–∞</div>
        <div class="nav-btn" onclick="showPage('matches')"><span>üí¨</span>–ú—ç—Ç—á–∏</div>
        <div class="nav-btn" onclick="showPage('profile')"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ---
        const SUPABASE_URL = '–¢–í–û–ô_URL_–ò–ó_SUPABASE';
        const SUPABASE_KEY = '–¢–í–û–ô_ANON_KEY_–ò–ó_SUPABASE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe?.user?.id || 12345; // –î–ª—è —Ç–µ—Å—Ç–æ–≤ –≤–Ω–µ –¢–ì —Å—Ç–∞–≤–∏–º 12345

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶ ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if(pageId === 'matches') loadMatches();
        }

        // --- –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–û–í ---
        const card = document.getElementById('main-card');
        const likeStamp = card.querySelector('.like');
        const nopeStamp = card.querySelector('.nope');
        let startX = 0;

        card.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            card.style.transition = 'none';
        });

        card.addEventListener('touchmove', e => {
            let x = e.touches[0].clientX - startX;
            let deg = x / 10;
            card.style.transform = `translateX(${x}px) rotate(${deg}deg)`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à—Ç–∞–º–ø—ã –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞
            if (x > 50) { likeStamp.style.opacity = x / 150; nopeStamp.style.opacity = 0; }
            else if (x < -50) { nopeStamp.style.opacity = -x / 150; likeStamp.style.opacity = 0; }
            else { likeStamp.style.opacity = 0; nopeStamp.style.opacity = 0; }
        });

        card.addEventListener('touchend', e => {
            let x = e.changedTouches[0].clientX - startX;
            if (Math.abs(x) > 120) {
                let side = x > 0 ? 'right' : 'left';
                completeSwipe(side);
            } else {
                card.style.transition = 'all 0.3s ease';
                card.style.transform = 'translateX(0) rotate(0)';
                likeStamp.style.opacity = 0;
                nopeStamp.style.opacity = 0;
            }
        });

        function completeSwipe(side) {
            card.style.transition = 'all 0.5s ease';
            card.style.transform = `translateX(${side === 'right' ? 500 : -500}px) rotate(${side === 'right' ? 30 : -30}deg)`;
            card.style.opacity = 0;
            
            console.log("–°–≤–∞–π–ø –≤ —Å—Ç–æ—Ä–æ–Ω—É: " + side);
            // –¢—É—Ç –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ Supabase: recordSwipe(side === 'right')

            setTimeout(() => {
                // –í–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ —Å–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö (—Ñ–µ–π–∫ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ)
                card.style.transition = 'none';
                card.style.transform = 'translateX(0) rotate(0)';
                card.style.opacity = 1;
                likeStamp.style.opacity = 0;
                nopeStamp.style.opacity = 0;
                // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ç: loadNextUser()
            }, 500);
        }

        // --- –§–£–ù–ö–¶–ò–ò –ë–î (SUPABASE) ---
        async function saveProfile() {
            const name = document.getElementById('form-name').value;
            const bio = document.getElementById('form-bio').value;
            const photo = document.getElementById('form-photo').value;

            const { error } = await supabase.from('profiles').upsert({
                tg_id: userId,
                first_name: name,
                bio: bio,
                photo_url: photo
            });

            if (error) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            else tg.showAlert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }

        async function loadMatches() {
            // –ó–∞–ø—Ä–æ—Å –≤ Supabase –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º—ç—Ç—á–µ–π
            // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
            const list = document.getElementById('matches-list');
            list.innerHTML = '<p style="color:gray">–°–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –¥–ª—è –ø–æ–∏—Å–∫–∞ –º—ç—Ç—á–µ–π...</p>';
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –∏–∑ –¢–ì –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if (tg.initDataUnsafe?.user) {
            document.getElementById('form-name').value = tg.initDataUnsafe.user.first_name;
            document.getElementById('user-name').innerText = tg.initDataUnsafe.user.first_name + ", 20";
        }
    </script>
</body>
</html>